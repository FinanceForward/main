<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta name="description" content="Dashboard | Find out where your money is going - FINANCE FORWARD">
   <meta name="keywords" content="Finance Forward, Finance, Forward, US, Sign In, FF, Fin, For, Finances">
   <title>Dashboard - Finance Forward</title>
   <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet">
   <link rel="icon" type="image/x-icon" href="../src/fflogo.png">
   <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=edit"/>
   <script defer src="../firestore.js" type="module"></script>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
   <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
   <script src="https://js.puter.com/v2/"></script>
</head>
<body>
   <header class="header">
       <button class="header__menu-toggle" id="menu-toggle" aria-label="Toggle menu">
           <img class="header__icon header__icon--menu" src="../src/icons/menu.png" alt="Menu">
       </button>
       <div class="header__title">
           Finance Forward <span class="header__version-badge"></span>
       </div>
       <div class="header__actions">
           <a href="../add-receipt" class="header__action-link" aria-label="Add Receipt">
               <img src="../src/icons/add.png" alt="Add Receipt" class="header__icon">
           </a>
           <img class="header__icon header__icon--logo" src="../src/fflogo.png" alt="Finance Forward Logo">
       </div>
   </header>

   <nav class="sidebar" id="sidebar">
       <h1 class="sidebar__title">Finance Forward</h1>
       <ul class="sidebar__nav-list">
          <li class="sidebar__nav-item"><a href="../dashboard"><img src="../src/icons/dashboard.png" alt=""> Dashboard</a></li>
           <li class="sidebar__nav-item"><a href="../add-receipt"><img src="../src/icons/add.png" alt=""> Add Receipt</a></li>
           <li class="sidebar__nav-item"><a href="../report"><img src="../src/icons/receipt_long.png" alt=""> Report</a></li>
           <li class="sidebar__nav-item"><a href="../links"><img src="../src/icons/log.png" alt=""> More Links</a></li>
           </ul>
       <div class="sidebar__footer">
           <a href="../settings/" class="sidebar__footer-link"><img src="../src/icons/settings.png" alt=""> Account</a>
           <a href="../legal/" class="sidebar__footer-link"><img src="../src/icons/gavel.png" alt=""> Legal</a>
       </div>
   </nav>

   <main class="main-content" id="main-content">
       <div class="loader" id="loader">
           <div class="loader__spinner"></div>
           <p class="loader__text">Loading Dashboard...</p>
       </div>

       <section class="dashboard dashboard--hidden" id="dashboard">
           <div class="dashboard__card dashboard__card--total">
               <h2 class="dashboard__card-title">Total Spent This Month</h2>
               <p class="dashboard__card-value" aria-live="polite">
                   <span id="total-value">0.00</span><br>
                   <a href="../add-receipt" class="dashboard__action-link"><img src="../src/icons/add.png" alt=""> Add A Receipt</a>
                   <a href="../navigator" class="dashboard__action-link"><img src="../src/icons/robot.png" alt=""> A.I. Assistant</a>
                   <a href="../report" class="dashboard__action-link"><img src="../src/icons/receipt_long.png" alt=""> Monthly Report</a>
               </p><br><hr><br>
               <h2 class="dashboard__card-title">Insights</h2>
               <p class="dashboard__card-value" id="auto-insights" aria-live="polite">
               </p>
           </div>
           <div class="dashboard__card dashboard__card--total">
            <hr>
            <br>
               <h2 class="dashboard__card-title">Quick Navigation</h2>
               <p class="dashboard__card-value" aria-live="polite">
                  <a class="dashboard__action-link" href="../navigator/" style="font-weight: 900; text-decoration: underline 2px;">Navigator (AI assistant) <img src="../src/icons/robot.png"></a>
                  <a class="dashboard__action-link" href="../add-receipt/">Add Receipt <img src="../src/icons/add.png"></a>
                  <a class="dashboard__action-link" href="../report/">View Report <img src="../src/icons/receipt_long.png"></a>
                  <a class="dashboard__action-link" href="../receipts/">View Receipts <img src="../src/icons/receipt.png"></a>
                  <a class="dashboard__action-link" href="../category_manager/">Category Manager <img src="../src/icons/manage.png"></a>
                  <a class="dashboard__action-link" href="../recurring_txs/">Recurring Transactions <img src="../src/icons/subscriptions.png"></a>
                  <a class="dashboard__action-link" href="../budget/">Budget</a>
                  <a class="dashboard__action-link" style="background-color: #4a4a4a;" href="../settings/">Settings <img src="../src/icons/settings.png"></a>
                  <a class="dashboard__action-link" style="background-color: #4a4a4a;" href="../">Info <img src="../src/icons/info.png"></a>
                  <a class="dashboard__action-link" style="background-color: #4a4a4a;" href="../legal/">Legal <img src="../src/icons/gavel.png"></a>
               </p>
           </div>
       </section>

       <div class="shortcuts-overlay shortcuts-overlay--hidden" id="shortcuts-overlay">
           <div class="shortcuts-overlay__content">
               <h2 class="shortcuts-overlay__title">Keyboard Shortcuts</h2>
               <ol class="shortcuts-overlay__list">
                   <li><kbd>Shift</kbd> + <kbd>R</kbd> = Add Receipt</li>
                   <li><kbd>Shift</kbd> + <kbd>V</kbd> = View Report</li>
                   <li><kbd>Shift</kbd> + <kbd>P</kbd> = Print Report</li>
                   <li><kbd>Shift</kbd> + <kbd>L</kbd> = View All Pages (Links)</li>
                   <li><kbd>Shift</kbd> + <kbd>D</kbd> = Go to Dashboard</li>
               </ol>
               <p class="shortcuts-overlay__note">Release <kbd>Shift</kbd> to close.</p>
           </div>
       </div>
   </main>
</body>
</html>
<style>
/* dashboard_gamma.css */

/* --- Base Styles & Variables (Consistent with Dashboard/Landing) --- */
:root {
   /* Color Palette */
   --color-background: #000000;
   --color-text: #ffffff;
   --color-text-other: #000000;
   --color-header-bg: #2482ba;
   --color-sidebar-bg: #29a4ed;
   --color-card-bg: #2F2C27;    /* Using card bg for form container */
   --color-dashboard-bg: #ffffff;
   --color-input-bg: #fff;
   --color-primary-accent: #29a4ed;
   --color-primary-accent-hover: #42b72a;
   --color-border-subtle: #4a4a4a;
   --color-error: #f44336; /* Added for potential future validation */
   --color-disabled: #5a5a5a; /* Added for disabled button */
   --color-overlay-bg: rgba(0, 0, 0, 0.75); /* Overlay background */

   /* Font */
   --font-family-base: 'Manrope', sans-serif;

   /* Spacing */
   --space-xs: 0.25rem; --space-sm: 0.5rem; --space-md: 1rem;
   --space-lg: 1.5rem; --space-xl: 2rem; --space-xxl: 3rem;

   /* Sizes */
   --header-height: 60px;
   --sidebar-width: 250px;

   /* Transitions */
   --transition-speed: 0.3s;
   --transition-ease: ease;

   /* Borders */
   --border-radius-sm: 4px;
   --border-radius-md: 8px;
   --border-radius-lg: 20px;
}

/* Reset */
* {
   margin: 0;
   padding: 0;
   box-sizing: border-box;
}

html {
   font-size: 16px; /* Base font size */
}

body {
   font-family: var(--font-family-base);
   background-color: var(--color-background);
   color: var(--color-text);
   line-height: 1.6;
   overflow-x: hidden; /* Prevent horizontal scroll */
}

a {
   text-decoration: none;
   color: inherit;
   transition: color var(--transition-speed) var(--transition-ease);
}

img {
   max-width: 100%;
   height: auto;
   display: block; /* Remove extra space below images */
}

ul, ol {
   list-style: none;
}

button {
   font-family: inherit;
   font-size: inherit;
   cursor: pointer;
   border: none;
   background-color: transparent;
   color: inherit;
   padding: 0; /* Remove default padding */
   border-radius: var(--border-radius-lg); /* Consistent button radius */
   transition: background-color var(--transition-speed) var(--transition-ease),
               opacity var(--transition-speed) var(--transition-ease);
}

/* --- Header --- */
.header {
   background-color: var(--color-header-bg);
   color: var(--color-text-other);
   display: flex;
   justify-content: space-between;
   align-items: center;
   padding: 0 var(--space-md); /* Use variables */
   height: var(--header-height);
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   z-index: 1000;
   box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Subtle shadow */
}

.header__menu-toggle {
   display: none; /* Hidden by default, shown in media query */
   background: none;
   border: none;
   padding: var(--space-sm);
   margin-right: var(--space-sm); /* Space between toggle and title */
}

.header__title {
   font-size: 1.5rem; /* 24px */
   font-weight: 700;
   display: flex;
   align-items: center;
   gap: var(--space-sm);
}

.header__version-badge {
   background-color: var(--color-sidebar-bg); /* Match sidebar */
   color: var(--color-text);
   padding: var(--space-xs) var(--space-sm);
   font-size: 0.8rem; /* 12.8px */
   border-radius: var(--border-radius-sm);
   font-weight: 700;
   text-transform: uppercase;
}

.header__actions {
   display: flex;
   align-items: center;
   gap: var(--space-md);
}

.header__action-link {
   display: flex; /* Ensure icon is vertically centered if text added later */
   align-items: center;
}

.header__icon {
   width: 25px; /* Original size */
   height: 25px; /* Original size */
   transition: opacity var(--transition-speed) var(--transition-ease);
}
.header__icon:hover {
   opacity: 0.8;
}

.header__icon--logo {
   width: 40px; /* Original size */
   height: 40px; /* Original size */
}

.header__icon--menu {
   width: 30px;
   height: 30px;
}

/* --- Sidebar --- */
.sidebar {
   background-color: var(--color-sidebar-bg);
   width: var(--sidebar-width);
   height: 100vh;
   position: fixed;
   top: 0; /* Align with top */
   left: 0;
   padding: var(--space-lg);
   padding-top: calc(var(--header-height) + var(--space-lg)); /* Account for header */
   overflow-y: auto;
   z-index: 900; /* Below header */
   transition: transform var(--transition-speed) var(--transition-ease);
   display: flex;
   flex-direction: column;
}

.sidebar__title {
   font-size: 1.5rem; /* 24px */
   margin-bottom: var(--space-xl);
   font-weight: 700;
   color: var(--color-text-other);
}

.sidebar__nav-list {
   flex-grow: 1; /* Takes up available space */
}

.sidebar__nav-item {
   margin-bottom: var(--space-sm);
}

.sidebar__nav-item a,
.sidebar__footer-link {
   color: var(--color-text-other);
   padding: var(--space-sm) var(--space-md); /* More padding */
   display: flex; /* Align icon and text */
   align-items: center;
   gap: var(--space-md); /* Space between icon and text */
   font-size: 1.125rem; /* 18px, slightly smaller than original */
   border-radius: var(--border-radius-md);
   transition: color var(--transition-speed) var(--transition-ease),
               background-color var(--transition-speed) var(--transition-ease);
}
.sidebar__nav-item a img,
.sidebar__footer-link img,
.sidebar__footer-link span { /* Include span for beta icon */
   width: 20px;
   height: 20px;
   opacity: 0.8; /* Slightly dim icons */
   flex-shrink: 0; /* Prevent icon/span from shrinking */
   display: inline-flex; /* Align beta icon better */
   align-items: center;
   justify-content: center;
}

.sidebar__nav-item a:hover,
.sidebar__footer-link:hover {
   color: var(--color-text);
   background-color: rgba(255, 255, 255, 0.05); /* Subtle hover */
}
.sidebar__nav-item a:hover img,
.sidebar__footer-link:hover img,
.sidebar__footer-link:hover span {
   opacity: 1;
}

.sidebar__button {
   background-color: var(--color-primary-accent);
   color: var(--color-text);
   border: none;
   padding: var(--space-sm) var(--space-md);
   width: 100%;
   margin-top: var(--space-lg);
   text-align: center;
   font-weight: 700;
   font-size: 1rem;
}

.sidebar__button:hover {
   background-color: var(--color-primary-accent-hover);
}

.sidebar__button--signin {
   /* Specific styles if needed */
}

.sidebar__footer {
   margin-top: var(--space-xl);
   padding-top: var(--space-lg);
   border-top: 1px solid var(--color-border-subtle); /* Separator */
}

.sidebar__footer-link {
   margin-top: var(--space-sm);
   font-size: 1rem; /* Smaller footer links */
}

/* Sidebar Active State (for mobile) */
.sidebar--active {
   transform: translateX(0);
}

/* --- Main Content Area --- */
.main-content {
   margin-top: var(--header-height);
   margin-left: var(--sidebar-width); /* Default margin for sidebar */
   padding: var(--space-xl);
   background-color: var(--color-card-bg);
   min-height: calc(100vh - var(--header-height));
   transition: margin-left var(--transition-speed) var(--transition-ease);
   position: relative; /* For loader positioning */
}

/* --- Loader --- */
.loader {
   position: absolute;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent overlay */
   display: flex;
   flex-direction: column;
   justify-content: center;
   align-items: center;
   z-index: 1100; /* Above everything */
   transition: opacity var(--transition-speed) var(--transition-ease), visibility var(--transition-speed) var(--transition-ease);
   opacity: 1;
   visibility: visible;
}

.loader--hidden {
   opacity: 0;
   visibility: hidden;
}

.loader__spinner {
   border: 4px solid rgba(255, 255, 255, 0.3);
   border-left-color: var(--color-primary-accent);
   border-radius: 50%;
   width: 50px;
   height: 50px;
   animation: spin 1s linear infinite;
   margin-bottom: var(--space-md);
}

@keyframes spin {
   to { transform: rotate(360deg); }
}

.loader__text {
   font-size: 1.2rem;
   color: var(--color-text);
}

/* --- Dashboard Section --- */
.dashboard {
   display: grid;
   grid-template-columns: 1fr 1fr;
   grid-template-rows: auto auto;
   gap: var(--space-xl);
   transition: opacity var(--transition-speed) var(--transition-ease), visibility var(--transition-speed) var(--transition-ease);
   opacity: 1;
   visibility: visible;
}

.dashboard--hidden {
   opacity: 0;
   visibility: hidden;
   position: absolute;
}

.dashboard__card {
   background-color: var(--color-card-bg);
   padding: var(--space-lg);
   border-radius: var(--border-radius-md);
   color: var(--color-text);
   display: flex;
   flex-direction: column;
   justify-content: center;
   text-align: center;
   min-height: 200px;
}

.dashboard__card-title {
   font-size: 1.125rem;
   font-weight: 700;
   margin-bottom: var(--space-md);
   color: var(--color-text);
}

.dashboard__card-value {
   font-size: 2.5rem;
   font-weight: 700;
   color: var(--color-primary-accent);
   line-height: 1.2;
}

.dashboard__card-text {
   color: var(--color-text) !important;
}

/* Specific card adjustments */
.dashboard__card--total {
   grid-column: 1 / 3;
}
.dashboard__card--total .dashboard__card-value {
   font-size: 3rem;
}

.currency-symbol {
  color: var(--color-text);
}

/* Actions Card (will automatically be row 2, col 2) */
.dashboard__card--actions {
   justify-content: center; /* Center actions vertically */
}

.dashboard__actions-container {
   display: flex;
   flex-direction: column; /* Stack actions vertically */
   gap: var(--space-md);
   align-items: center; /* Center buttons horizontally */
}

.dashboard__action-link,
.dashboard__card-action { /* Keep this selector if used elsewhere */
   background-color: var(--color-primary-accent);
   color: var(--color-text);
   padding: var(--space-sm) var(--space-lg);
   border-radius: var(--border-radius-lg); /* Match button radius */
   font-weight: 700;
   font-size: 1rem; /* 16px */
   display: inline-flex; /* Use inline-flex for alignment */
   align-items: center;
   justify-content: center;
   gap: var(--space-sm);
   text-align: center;
   min-width: 150px; /* Minimum width for actions */
   transition: background-color var(--transition-speed) var(--transition-ease);
   width:fit-content;
   align-self: center;
}
.dashboard__action-link img,
.dashboard__action-link span, /* Include span for icon */
.dashboard__card-action img {
   width: 18px;
   height: 18px;
   flex-shrink: 0; /* Prevent icon/span from shrinking */
   display: inline-flex; /* Align beta icon better */
   align-items: center;
   justify-content: center;
}

/* --- Shortcuts Overlay --- */
.shortcuts-overlay {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0, 0, 0, 0.85); /* Darker overlay */
   display: flex;
   justify-content: center;
   align-items: center;
   z-index: 1200; /* Above loader */
   padding: var(--space-xl);
   opacity: 1;
   visibility: visible;
   transition: opacity var(--transition-speed) var(--transition-ease), visibility var(--transition-speed) var(--transition-ease);
}

.shortcuts-overlay--hidden {
   opacity: 0;
   visibility: hidden;
}

.shortcuts-overlay__content {
   background-color: var(--color-card-bg);
   padding: var(--space-xl) var(--space-xxl);
   border-radius: var(--border-radius-md);
   max-width: 500px;
   width: 90%;
   text-align: center;
}

.shortcuts-overlay__title {
   font-size: 1.5rem;
   margin-bottom: var(--space-lg);
}

.shortcuts-overlay__list {
   text-align: left;
   margin-bottom: var(--space-lg);
}

.shortcuts-overlay__list li {
   margin-bottom: var(--space-md);
   font-size: 1.1rem;
}

.shortcuts-overlay__list kbd {
   display: inline-block;
   padding: var(--space-xs) var(--space-sm);
   font-family: monospace;
   font-size: 0.9em;
   background-color: var(--color-input-bg);
   border-radius: var(--border-radius-sm);
   border: 1px solid var(--color-border-subtle);
   margin: 0 var(--space-xs);
}

.shortcuts-overlay__note {
   font-size: 0.9rem;
   color: rgba(255, 255, 255, 0.7);
}
.shortcuts-overlay__note kbd {
    font-size: 0.8em;
}

/* --- Responsive Design --- */
@media screen and (max-width: 817px) {
   .header__menu-toggle {
       display: block; /* Show hamburger menu */
   }

   .header__title {
        font-size: 1.25rem; /* Slightly smaller title */
   }
    .header__version-badge {
       display: none;
    }

   .sidebar {
       transform: translateX(-100%); /* Hide sidebar off-screen */
       z-index: 1100; /* Ensure sidebar is above main content when active */
       padding-top: var(--space-lg); /* Reset padding top */
       height: 100vh; /* Full height */
       top: 0;
   }

   .sidebar--active {
       transform: translateX(0);
       box-shadow: 5px 0 15px rgba(0,0,0,0.2); /* Add shadow when active */
   }

   .main-content {
       margin-left: 0; /* Remove sidebar margin */
       padding: var(--space-lg); /* Adjust padding */
   }

   /* Adjust dashboard grid for single column (Mobile) */
   .dashboard {
       grid-template-columns: 1fr; /* Single column layout */
       gap: var(--space-lg);
   }

   /* --- NEW: Reset column span for total card on mobile --- */
   .dashboard__card--total {
        margin: 0;
        padding: 0;
        grid-column: auto; /* Reset span to default */
   }
   /* --- END NEW --- */

   .dashboard__card {
       min-height: auto; /* Allow cards to shrink */
       padding: var(--space-md);
   }

   .dashboard__card-value {
       font-size: 2rem; /* Adjust font size */
   }
   .dashboard__card--total .dashboard__card-value {
       font-size: 2.5rem; /* Adjust font size */
   }

   .dashboard__list-item {
       font-size: 1rem; /* Adjust font size */
   }

   .dashboard__action-link,
   .dashboard__card-action {
       font-size: 0.9rem;
       padding: var(--space-sm) var(--space-md);
       min-width: 120px;
    }
}
</style>

<script>
// dashboard_gamma.js

// --- Global Variables & Configuration ---
// Assume 'version' is defined globally or in firestore.js
const versionNOTES = "This new version features the ability to add budgets!\nTry it out with the Edit Budget button on the bottom of the page!"; // Example notes

// --- DOM Element Selectors ---
const loader = document.getElementById('loader');
const dashboardElement = document.getElementById('dashboard');
const shortcutsOverlay = document.getElementById('shortcuts-overlay');
const menuToggle = document.getElementById('menu-toggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('main-content');
const signInButton = document.getElementById('signin-button');

// Dashboard Value Elements
const totalValueElement = document.getElementById('total-value');

/**
* Gets a cookie value by name.
* @param {string} cname - The name of the cookie.
* @returns {string} The cookie value or an empty string if not found.
*/
function getCookie(cname) {
   const name = cname + "=";
   const decodedCookie = decodeURIComponent(document.cookie);
   const ca = decodedCookie.split(';');
   for(let i = 0; i < ca.length; i++) { // Fixed semicolon by user
       let c = ca[i];
       while (c.charAt(0) === ' ') {
           c = c.substring(1);
       }
       if (c.indexOf(name) === 0) {
           return c.substring(name.length, c.length);
       }
   }
   return "";
}

let currency = null;

/**
* Sets the currency symbols based on user settings.
* @param {string} currencySetting - The currency string (e.g., "$", "€", "£*").
*/
function setCurrencyDisplay(currencySetting) {
   let symbol = currencySetting || ''; // Default to $
   const positionAfter = symbol.includes('*');
   symbol = symbol.replace('*', '');

   // Clear all first
   document.querySelectorAll('.currency-symbol').forEach(el => el.innerHTML = '');

   if (positionAfter) {
       currency = (x) => `${x.toFixed(2)} <span class="currency-symbol">${symbol}</span>`;
   } else {
       currency = (x) => `<span class="currency-symbol">${symbol}</span>${x.toFixed(2)}`;
   }
    console.log(`Currency set to: ${symbol} (${positionAfter ? 'After' : 'Before'})`);
}

/**
* Toggles the visibility of the loader.
* @param {boolean} show - True to show, false to hide.
*/
function toggleLoader(show) {
   if (show) {
       loader?.classList.remove('loader--hidden');
   } else {
       loader?.classList.add('loader--hidden');
   }
}

/**
* Toggles the visibility of the main dashboard content.
* @param {boolean} show - True to show, false to hide.
*/
function toggleDashboard(show) {
    if (show) {
       dashboardElement?.classList.remove('dashboard--hidden');
   } else {
       dashboardElement?.classList.add('dashboard--hidden');
   }
}

/**
* Sets the budget progress bar and text.
* @param {number} percentage - The percentage of the budget used.
*/
function setBudgetProgress(progress) {
   // Removed: All code related to budget-bar
}

// --- Subscription Calculation Logic (Copied from original, consider refactoring if complex) ---
class DateConfig {
   static today = () => [new Date().getDate(), new Date().getMonth() + 1] // [DayOfMonth, MonthNumber]

   static getWeekdaysPassed(targetDay) { // targetDay: 0=Sun, 1=Mon,...
       const today = new Date();
       const currentMonth = today.getMonth();
       const currentYear = today.getFullYear();
       let count = 0;
       // Iterate from the 1st day of the month up to today
       for (let day = 1; day <= today.getDate(); day++) {
           const date = new Date(currentYear, currentMonth, day);
           if (date.getDay() === targetDay) {
               count++;
           }
       }
       return count;
   }
}

class Sub {
   static DOW_MAP = {'sunday':0 , 'monday':1 , 'tuesday':2 , 'wednesday':3 , 'thursday':4 , 'friday':5 , 'saturday':6};

   static weekly(price, dayOfWeekName) {
       const targetDay = Sub.DOW_MAP[dayOfWeekName.toLowerCase()];
       if (targetDay === undefined) return 0; // Invalid day name
       return DateConfig.getWeekdaysPassed(targetDay) * price;
   }

   static monthly(price, dayOfMonth) {
       // Ensure dayOfMonth is a number
       const numericDayOfMonth = parseInt(dayOfMonth, 10);
       if (isNaN(numericDayOfMonth)) return 0;
       return (DateConfig.today()[0] >= numericDayOfMonth ? price : 0);
   }

   static yearly(price, dateArray) { // Expects dateArray like [DayOfMonth, MonthNumber]
       if (!Array.isArray(dateArray) || dateArray.length < 2) return 0;
       const [dayOfMonth, monthNumber] = dateArray.map(d => parseInt(d, 10));
        if (isNaN(dayOfMonth) || isNaN(monthNumber)) return 0;

       const [todayDay, todayMonth] = DateConfig.today();
       // Check if the month has passed or if it's the current month and the day has passed/is today
       if (todayMonth > monthNumber || (todayMonth === monthNumber && todayDay >= dayOfMonth)) {
            return price;
       }
       return 0;
   }

   static processTotal(sub) {
       // Basic validation
       if (!sub || typeof sub.price !== 'number' || !sub.frequency || !sub.freq_value) {
           console.error('Invalid subscription object:', sub);
           return 0;
       }

       try {
           switch (sub.frequency.toLowerCase()) {
               case 'weekly':
                   return Sub.weekly(sub.price, sub.freq_value);
               case 'monthly':
                   return Sub.monthly(sub.price, sub.freq_value);
               case 'yearly':
                   // Assuming freq_value for yearly is an array [day, month] or string "day-month"
                   let dateVal = sub.freq_value;
                   if (typeof dateVal === 'string') {
                       dateVal = dateVal.split(/[-/]/).map(Number); // Handle "DD-MM" or "DD/MM"
                   }
                   return Sub.yearly(sub.price, dateVal);
               default:
                   console.error('Unknown subscription frequency:', sub.frequency);
                   return 0;
           }
       } catch (error) {
           console.error('Error processing subscription:', sub, error);
           return 0;
       }
   }

   static processGrandTotal(subs) {
       if (!Array.isArray(subs)) return 0;
       return subs.reduce((total, sub) => total + Sub.processTotal(sub), 0);
   }
}


// --- Event Listeners ---

// Sidebar Toggle
menuToggle?.addEventListener('click', () => {
   sidebar?.classList.toggle('sidebar--active');
   // Optional: Add overlay to main content when sidebar is open on mobile
   mainContent?.classList.toggle('main-content--overlay-active');
});

// Close sidebar if clicking outside of it (on mobile)
document.addEventListener('click', (event) => {
   if (window.innerWidth <= 817) { // Only on mobile breakpoint
       const isClickInsideSidebar = sidebar?.contains(event.target);
       const isClickOnMenuToggle = menuToggle?.contains(event.target);
       if (!isClickInsideSidebar && !isClickOnMenuToggle && sidebar?.classList.contains('sidebar--active')) {
           sidebar.classList.remove('sidebar--active');
       }
   }
});


document.addEventListener('keydown', (event) => {
   // Show shortcuts overlay on Shift press (if not already typing in an input)
   if (event.key === 'Shift' && !event.repeat) {
        if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
           shortcutsOverlay?.classList.remove('shortcuts-overlay--hidden');
           // Optional: Hide dashboard content while shortcuts are shown
           // dashboardElement?.classList.add('dashboard--hidden');
        }
   }

   // Handle specific shortcuts only when Shift is held
   if (event.shiftKey) {
       // Prevent default browser behavior if necessary
       // event.preventDefault();

       switch (event.key.toUpperCase()) {
           case 'D':
               window.location.href = '../dashboard'; // Already here, but good practice
               break;
           case 'R':
               window.location.href = '../add-receipt';
               break;
           case 'V':
               window.location.href = '../report';
               break;
           case 'P':
               window.location.href = '../printout'; // Assuming this page exists
               break;
           case 'L':
               window.location.href = '../links';
               break;
       }
   }
});

document.addEventListener('keyup', (event) => {
   // Hide shortcuts overlay on Shift release
   if (event.key === 'Shift') {
       shortcutsOverlay?.classList.add('shortcuts-overlay--hidden');
       // Optional: Show dashboard content again if it was hidden
       // if (!loader?.classList.contains('loader--hidden')) { // Only show if not loading
       //     dashboardElement?.classList.remove('dashboard--hidden');
       // }
   }
});


// --- Initialization and Data Fetching ---

document.addEventListener('DOMContentLoaded', () => {
   console.log("DOM Loaded. Initializing Dashboard...");
   const startTime = Date.now();

   // 1. Show Loader, Hide Dashboard
   toggleLoader(true);
   toggleDashboard(false);

   // Backup timeout to hide loader if something goes wrong
   const loaderTimeout = setTimeout(() => {
       console.warn('Loader timeout executed. Hiding loader.');
       toggleLoader(false);
       toggleDashboard(true); // Show dashboard even if data failed
   }, 8000); // Increased timeout slightly

   // 2. Fetch User Data and Compute Totals
   // Ensure DB object is available from firestore.js
   if (typeof DB === 'undefined' || !DB.u || !DB.uCompute || !DB.uDoc) {
       console.error('Firestore DB object not found. Ensure firestore.js is loaded correctly.');
       toggleLoader(false); // Hide loader
       toggleDashboard(true); // Show dashboard (maybe with an error message)
       clearTimeout(loaderTimeout);
       // Display an error message to the user here
       return;
   }

   DB.u.get(getCookie('hash')).then(async (user) => {
       if (!user) {
           console.error("Failed to fetch user data.");
           // Handle error - maybe redirect to login or show error message
           toggleLoader(false);
           toggleDashboard(true);
           clearTimeout(loaderTimeout);
           return;
       }

       console.log("User data fetched:", user);

       // Check version and show notes (using global 'version' variable)
       if (user.version !== version) {
           console.log("Version mismatch. Updating.");
           DB.u.update(getCookie('hash'), { 'version': version }).catch(err => console.error("Failed to update user version:", err));
       }

       // Initialize custom categories if they don't exist
       user.c_categories = user.c_categories || [];

       // Set Currency Display
       setCurrencyDisplay(user.currency);

       // Calculate current month string (YYYY-MM)
       const d = new Date();
       const currentMonthStr = d.getFullYear().toString() + '-' + String(d.getMonth() + 1).padStart(2, '0');

       try {
           // Fetch monthly totals and subscriptions
           const [monthlyTotals, subscriptions] = await Promise.all([
               DB.uCompute.all(getCookie('hash'), 'totals', currentMonthStr),
               DB.uDoc.allDocs(getCookie('hash'), 'subscriptions'),
           ]);

           console.log("Monthly Totals Data:", monthlyTotals);
           console.log("Subscriptions Data:", subscriptions);

           // Combine monthly totals with calculated subscription costs for the current month
           const combinedTotals = { ...monthlyTotals }; // Start with receipt totals
           subscriptions.forEach(sub => {
               const subCost = Sub.processTotal(sub);
               // Add subscription cost to its category, or a general 'Subscriptions' category
               const category = sub.category || 'Subscriptions'; // Use specified category or default
               combinedTotals[category] = (combinedTotals[category] || 0) + subCost;
           });
            console.log("Combined Totals (Receipts + Subs):", combinedTotals);


           // Calculate Grand Total
           const grandTotal = Object.values(combinedTotals).reduce((sum, value) => sum + (typeof value === 'number' ? value : 0), 0);
           totalValueElement.innerHTML = currency(grandTotal);

           // 4. Hide Loader, Show Dashboard
           clearTimeout(loaderTimeout); // Clear the backup timeout
           toggleLoader(false);
           toggleDashboard(true);

           const endTime = Date.now();
           console.log(`Dashboard initialized and data loaded in ${endTime - startTime}ms`);

           if (user.hasOwnProperty('newaccount') && user['newaccount'] == true) {
               newAccountTour();
           }

       } catch (error) {
           console.error("Error fetching or processing dashboard data:", error);
           // Display error state to user
           clearTimeout(loaderTimeout);
           toggleLoader(false);
           toggleDashboard(true); // Show dashboard potentially with error message display
            totalValueElement.innerHTML = 'Error';
       }

   }).catch(error => {
       console.error("Failed to get user data:", error);
       clearTimeout(loaderTimeout);
       toggleLoader(false);
       // Redirect to login or show a critical error message
   });
});

function newAccountTour() {
   console.info("Running New Account Tour!")
   DB.u.update(getCookie('hash'), { 'newaccount': false }).catch(err => console.error("Failed to update user newaccount status:", err));
   // Add tour logic here
   const tour = new Shepherd.Tour({
     defaultStepOptions: {
       cancelIcon: {
         enabled: true
       },
       classes: 'class-1 class-2',
       scrollTo: { behavior: 'smooth', block: 'center' }
     },
     useModalOverlay: true,
   });

   tour.addStep({
     title: 'Welcome to Finance Forward!',
     text: 'This is your dashboard. Let\'s take a quick tour.',
     attachTo: {
       element: '.header__title',
       on: 'bottom'
     },
     buttons: [
       {
         action() {
           return this.next();
         },
         text: 'Next',
         classes: 'shepherd-button-primary' // Add primary class
       }
     ],
     id: 'welcome'
   });

   tour.addStep({
     title: 'Add Receipts',
     text: 'Click here to add your receipts.',
     attachTo: {
       element: '.header__actions a[href="../add-receipt"]',
       on: 'bottom'
     },
     buttons: [
       {
         action() {
           return this.back();
         },
         classes: 'shepherd-button-secondary',
         text: 'Back'
       },
       {
         action() {
           return this.next();
         },
         text: 'Next',
         classes: 'shepherd-button-primary' // Add primary class
       }
     ],
     id: 'add-receipt'
   });

   tour.addStep({
     title: 'Dashboard Title Link',
     text: 'Click the title to return to the dashboard from any page.',
     attachTo: {
       element: '.header__title',
       on: 'bottom'
     },
     buttons: [
       {
         action() {
           return this.back();
         },
         classes: 'shepherd-button-secondary',
         text: 'Back'
       },
       {
         action() {
           return this.next();
         },
         text: 'Next',
         classes: 'shepherd-button-primary' // Add primary class
       }
     ],
     id: 'dashboard-link'
   });

     tour.addStep({
       title: 'View Report',
       text: 'Click here to view detailed reports.',
       attachTo: {
         element: '.sidebar__nav-item a[href="../report"]',
         on: 'right'
       },
       buttons: [
         {
           action() {
             return this.back();
           },
           classes: 'shepherd-button-secondary',
           text: 'Back'
         },
         {
           action() {
             return this.next();
           },
           text: 'Next',
           classes: 'shepherd-button-primary' // Add primary class
         }
       ],
       id: 'view-report'
     });

   tour.addStep({
     title: 'Top Categories',
     text: 'See your spending habits by category.',
     attachTo: {
       element: '.dashboard__card--categories',
       on: 'top'
     },
     buttons: [
       {
         action() {
           return this.back();
         },
         classes: 'shepherd-button-secondary',
         text: 'Back'
       },
       {
         action() {
           return this.next();
         },
         text: 'Next',
         classes: 'shepherd-button-primary' // Add primary class
       }
     ],
     id: 'top-categories'
   });

   tour.addStep({
     title: 'Budget Status',
     text: 'Here you can see your budget status.',
     attachTo: {
       element: '.dashboard__card--budget',
       on: 'top'
     },
     buttons: [
       {
         action() {
           return this.back();
         },
         classes: 'shepherd-button-secondary',
         text: 'Back'
       },
       {
         action() {
           return this.next();
         },
         text: 'Next',
         classes: 'shepherd-button-primary' // Add primary class
       }
     ],
     id: 'budget-status'
   });

   tour.addStep({
     title: 'Edit Budget',
     text: 'Click here to edit your budget.',
     attachTo: {
       element: '.dashboard__card--budget a[href="../budget/"]',
       on: 'top'
     },
     buttons: [
       {
         action() {
           return this.back();
         },
         classes: 'shepherd-button-secondary',
         text: 'Back'
       },
       {
         action() {
           return tour.complete();
         },
         text: 'Finish',
         classes: 'shepherd-button-primary' // Add primary class
       }
     ],
     id: 'edit-budget'
   });

   tour.start();
}
</script>
<link rel="stylesheet" href="../src/globalstyles.css">